<html lang="en">
<head>
    <title>Engagement Cloud SDK demo</title>
    <!--    <script src="engagement-cloud-sdk-html.js"></script>-->
    <script src="engagement-cloud-sdk-loader.js"></script>
    <style>
        .selected {
            background-color:red;
        }
    </style>
</head>
<body>
<div style="display: flex; gap:1rem; flex-wrap:no-wrap">
    <div style="flex: 1;">
        <button type="button" id="button-sdk-test">Enable Tracking with <strong>sdk-test</strong>
            account
        </button>
    </div>
    <div style="flex: 1;">
        <button type="button" id="button-integration-demo">Enable Tracking with
            <strong>integration-demo</strong> account
        </button>
        <small>For testing with old push payload only</small>
    </div>
</div>
<hr>
<label>CustomEventName:
    <input id="customEventNameInput" name="customEventName" type="text">
</label>
<button type="button" id="button-custom-event">Track!</button>
<button type="button" id="button-navigate-event">Track navigate event</button>
<div style="margin-top:32px;">
    <button type="button" id="button-disable-sdk">Disable tracking in SDK</button>
</div>
<hr/>
<div class="embedded-messaging-demo">
    <p>Embedded Messaging Demo</p>
    <div class="embedded-messaging-demo-container">
        <div class="compact-view-display">
            <button type="button" id="button-render-compact-view">Open Compact View</button>
            <div id="example-compact-view-tab" class="hidden" style="height:400px; width:300px">
                <ec-embedded-messaging-compact></ec-embedded-messaging-compact>
            </div>
        </div>
        <div class="detail-view-display">
            <p>Detail view</p>
            <ec-embedded-messaging custom-message-item-element-name="custom-message-item"></ec-embedded-messaging>
        </div>
    </div>
</div>
</body>

<script>
    let engagementCloud = window.EngagementCloud;
    document.getElementById("button-sdk-test").onclick = async () => {
        <!--     const config = new window["engagement-cloud-sdk"].EngagementCloudConfig(-->
        <!--         "EMSA4-90136",-->
        <!--         null-->
        <!--     )-->

        const config = {applicationCode: "EMSE3-B4341"};

        await engagementCloud.setup.enable(config, async () => { return {contactFieldValue: "test@test.com"} });
        await engagementCloud.setup.setOnContactLinkingFailedCallback(async () => { return {contactFieldValue: "test@test.com"} });
        await engagementCloud.contact.link("test@test.com");
        engagementCloud.events.on("app_event", (event) => console.log(JSON.stringify(event)));
    }

    document.getElementById("button-integration-demo").onclick = async () => {
        const config = new window["engagement-cloud-sdk"].EngagementCloudConfig(
            "EMS04-F3514",
            null,
            null,
            new window["engagement-cloud-sdk"].ServiceWorkerOptions(
                "BKlWDU3MxVpAEp7rjC5p9VYOhGBauYPO7K7b0117suJAoxaFzIwV4FT45eFI_hHBXgPlgKHyHDrbi1BpoKuiUww",
                "/ec-service-worker.js"
            )
        )
        await engagementCloud.setup.enable(config, async () => { return {contactFieldValue: "test2@test.com"} });
        await engagementCloud.setup.setOnContactLinkingFailedCallback(async () => { return {contactFieldValue: "test2@test.com"} });
        await engagementCloud.contact.link("test2@test.com");
    }

    document.getElementById("button-custom-event").onclick = async () => {
        const name = document.getElementById("customEventNameInput").value;
        await engagementCloud.event.trackEvent({name: name, attributes: {"key1": "value1"}});
    }

    document.getElementById("button-navigate-event").onclick = async () => {
        await engagementCloud.event.trackNavigation("https://www.emarsys.com");
    }

    document.getElementById("button-disable-sdk").onclick = async () => {
        await engagementCloud.setup.disable();
    }

    document.getElementById("button-render-compact-view").onclick = () => {
        document.querySelector('#example-compact-view-tab').classList.toggle("hidden");
    }

    engagementCloud.ready.then(() => {
        document.querySelector('ec-embedded-messaging-compact')
            .addEventListener('navigate', (e) => {
                console.log("Navigating to somewhere.");
            });
    });
    
    class MyCustomMessageItem extends HTMLElement {
        static get observedAttributes() {
            return ["image", "title", "lead","image-alt-text", "is-not-opened", "is-selected", "is-pinned", "categories"]
        }

        constructor() {
            super();
            this.attachShadow({mode: "open"});
        }

        connectedCallback() {
            this.render();
        }

        attributeChangedCallback(name, oldValue, newValue) {
            if (name === "is-selected") {
                this.updateSelected()
            }
            if (oldValue !== newValue) {
                this.render();
            }
        }

        updateSelected() {
            const isSelected =
                this.hasAttribute("is-selected") &&
                this.getAttribute("is-selected") !== "false";

            this.classList.toggle("selected", isSelected);
        }

        render() {
            const title = this.getAttribute("title") ?? "";
            const lead = this.getAttribute("lead") ?? "";
            const image = this.getAttribute("image") ?? "";
            const imageAltText = this.getAttribute("image-alt-text") ?? "";
            const receivedAt = this.getAttribute("received-at") ?? "";
            const isSelected = this.getAttribute("is-selected") ?? false;
            const isNotOpened = this.getAttribute("is-not-opened") ?? false;
            const isPinned = this.getAttribute("is-pinned") ?? false;
            const isDeleted = this.getAttribute("is-deleted") ?? false;
            const categoriesAttr = this.getAttribute("categories") ?? "[]";
            const categories = JSON.parse(categoriesAttr);

            this.shadowRoot.innerHTML = `
    <style>
      .card {
        margin: 0;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
      }
      img {
        max-width: 100%;
        border-radius: 4px;
      }
      h3 {
        margin: 8px 0 4px;
      }
      p {
        margin: 0;
        color: #555;
      }
      ul {
        list-style-type: none;
      }
      .categories-container {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row;
        gap: 4px;
      }
      .category-chip {
       align-content: space-evenly;
       border-radius: 16px;
       padding: 12px;
       background-color: #9cc7f1;
       border: 1px solid #007f6a;
      }
    </style>

    <div class="card">
      ${image ? `<img src="${image}" alt="">` : ""}
      <h3>${title}</h3>
      <p>${lead}</p>
      <ul>
        <li>ImageAltText: ${imageAltText}</li>
        <li>ReceivedAt: ${receivedAt}</li>
        <li>IsSelected: ${isSelected}</li>
        <li>IsNotOpened: ${isNotOpened}</li>
        <li>IsPinned: ${isPinned}</li>
        <li>IsDeleted: ${isDeleted}</li>
        <li>Categories: ${categoriesAttr}</li>
      </ul>
     <div class="categories-container">
        ${categories.map((category) => `<div class="category-chip">${category.text}</div>`).join('')}
      </div>
    </div>
  `;
        }
    }

    window.customElements.define("custom-message-item", MyCustomMessageItem)
</script>
<style>
    body {
        padding: 8px;
    }

    .hidden {
        visibility: hidden;
    }

    .embedded-messaging-demo {
        display: flex;
        flex-direction: column;

        > p {
            display: flex;
        }
    }

    .embedded-messaging-demo-container {
        display: flex;
        flex-direction: row;
    }

    .compact-view-display {
        flex: 1;
        margin-bottom: 32px;
    }

    .detail-view-display {
        flex: 5;
        height: 600px;
    }
</style>
</html>