name: Publish Artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run â€” build and validate without publishing'
        type: boolean
        default: true

env:
  DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
  VERSION: 0.0.${{ github.run_number }}
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
  ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
  ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
  ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
  ANDROID_RELEASE_STORE_FILE_BASE64: ${{ secrets.ANDROID_RELEASE_STORE_FILE_BASE64 }}
  GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SLACK_ICON: https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Kotlin_Icon.svg/1200px-Kotlin_Icon.svg.png

permissions:
  contents: write
  packages: write


jobs:
  build-android:
    name: Build / Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Android release AARs
        run: make build-android
        env:
          VERSION_OVERRIDE: ${{ env.VERSION }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          retention-days: 1
          if-no-files-found: error
          path: |
            engagement-cloud-sdk/build/outputs/aar/*-release.aar
            engagement-cloud-sdk-android-fcm/build/outputs/aar/*-release.aar
            engagement-cloud-sdk-android-hms/build/outputs/aar/*-release.aar


  build-ios:
    name: Build / iOS
    runs-on: macos-latest
    env:
      SPM_BUILD: release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build iOS frameworks (all architectures)
        run: make build-ios-all-archtypes
        env:
          VERSION_OVERRIDE: ${{ env.VERSION }}

      - name: Upload iOS XCFramework artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          retention-days: 1
          if-no-files-found: error
          path: |
            engagement-cloud-sdk/build/XCFrameworks/release/
            ios-notification-service/build/XCFrameworks/release/


  build-js:
    name: Build / JS (html)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install npm dependencies
        run: npm install

      - name: Build JS html variant
        run: make build-js-html

      - name: Assemble NPM package
        run: |
          mkdir -p dist/npm
          cp engagement-cloud-sdk/build/kotlin-webpack/js/productionExecutable/engagement-cloud-sdk-html.js dist/npm/
          cp build/js/packages/engagement-cloud-sdk/kotlin/engagement-cloud-sdk-html.d.ts dist/npm/ 2>/dev/null || true
          sed "s/\"version\": \"0.0.0\"/\"version\": \"${{ env.VERSION }}\"/" \
            engagement-cloud-sdk/npm-package.json > dist/npm/package.json

      - name: Upload JS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-artifacts
          retention-days: 1
          if-no-files-found: error
          path: dist/npm/


  lint:
    name: Lint
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run lint
        run: make lint


  test-android:
    name: Test / Android (unit)
    needs: build-android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Android unit tests
        run: ./gradlew :engagement-cloud-sdk:allTests -x :composeApp:test


  test-ios:
    name: Test / iOS
    needs: build-ios
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run iOS tests
        run: make test-ios


  test-web:
    name: Test / Web
    needs: build-js
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install npm dependencies
        run: npm install

      - name: Install Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

      - name: Run web tests
        run: make test-web

      - name: Run SDK loader tests
        run: make test-sdk-loader


  publish-maven:
    name: Publish / Maven (GitHub Packages)
    needs: [lint, test-android]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Publish to GitHub Packages Maven
        if: env.DRY_RUN != 'true'
        run: make publish-maven
        env:
          VERSION_OVERRIDE: ${{ env.VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPO: ${{ github.repository }}


  publish-npm:
    name: Publish / NPM (GitHub Packages)
    needs: test-web
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@emartech'

      - name: Download JS artifacts
        uses: actions/download-artifact@v4
        with:
          name: js-artifacts
          path: dist/npm/

      - name: Publish to GitHub Packages NPM
        if: env.DRY_RUN != 'true'
        run: npm publish dist/npm/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  publish-ios-spm:
    name: Publish / iOS SPM (GitHub Release)
    needs: test-ios
    runs-on: macos-latest
    env:
      SPM_BUILD: release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create GitHub Release for SPM artifact
        if: env.DRY_RUN != 'true'
        id: spm_release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: spm-${{ env.VERSION }}
          name: SPM Release ${{ env.VERSION }}
          prerelease: true
          generate_release_notes: false

      - name: Publish iOS SPM via kmmBridgePublish
        if: env.DRY_RUN != 'true'
        run: make publish-ios-spm
        env:
          VERSION_OVERRIDE: ${{ env.VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_ARTIFACT_RELEASE_ID: ${{ steps.spm_release.outputs.id }}


  report-slack:
    name: Report / Slack
    if: always()
    needs: [lint, test-android, test-ios, test-web, publish-maven, publish-npm, publish-ios-spm]
    runs-on: ubuntu-latest
    steps:
      - name: Compute Slack prefix
        id: prefix
        run: |
          if [ "${{ env.DRY_RUN }}" = "true" ]; then
            echo "value=[DRY RUN] " >> "$GITHUB_OUTPUT"
          else
            echo "value=" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack (failure)
        if: ${{ !cancelled() && contains(needs.*.result, 'failure') }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: mobile-team-ci
          text: '${{ steps.prefix.outputs.value }}Publish pipeline failed! :man-gesturing-no: :blobcatfearful:'
          fields: repo,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}

      - name: Notify Slack (success)
        if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: mobile-team-ci
          text: '${{ steps.prefix.outputs.value }}Publish pipeline succeeded! v${{ env.VERSION }} :man-gesturing-ok: :bananadance:'
          fields: repo,workflow,job,took
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}
