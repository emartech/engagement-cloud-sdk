name: Publish Artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run â€” build and validate without publishing'
        type: boolean
        default: true

env:
  DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run == true }}
  VERSION: 0.0.${{ github.run_number }}
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'
  USE_LOCAL_DEPENDENCY: ${{ vars.USE_LOCAL_DEPENDENCY }}
  RELEASE_MODE: ${{ vars.RELEASE_MODE }}
  FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
  FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
  GOOGLE_OAUTH_SERVER_CLIENT_ID: ${{ secrets.GOOGLE_OAUTH_SERVER_CLIENT_ID }}
  GOOGLE_SERVICES_API_KEY: ${{ secrets.GOOGLE_SERVICES_API_KEY }}
  OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
  OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
  ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
  ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
  ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD }}
  ANDROID_RELEASE_STORE_FILE_BASE64: ${{ secrets.ANDROID_RELEASE_STORE_FILE_BASE64 }}
  SONATYPE_STAGING_PROFILE_ID: ${{ secrets.SONATYPE_STAGING_PROFILE_ID }}
  SONATYPE_SIGNING_KEY_ID: ${{ secrets.SONATYPE_SIGNING_KEY_ID }}
  SONATYPE_SIGNING_PASSWORD: ${{ secrets.SONATYPE_SIGNING_PASSWORD }}
  SONATYPE_SIGNING_SECRET_KEY_RING_FILE: ${{ secrets.SONATYPE_SIGNING_SECRET_KEY_RING_FILE }}
  GOOGLE_SERVICES_JSON_BASE64: ${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SLACK_ICON: https://upload.wikimedia.org/wikipedia/commons/thumb/0/06/Kotlin_Icon.svg/1200px-Kotlin_Icon.svg.png
  DETECT_LATEST_RELEASE_VERSION: ${{ secrets.DETECT_LATEST_RELEASE_VERSION }}
  DETECT_PROJECT_USER_GROUPS: ${{ secrets.DETECT_PROJECT_USER_GROUPS }}
  DETECT_PROJECT_VERSION_DISTRIBUTION: ${{ secrets.DETECT_PROJECT_VERSION_DISTRIBUTION }}
  BLACKDUCK_ACCESS_TOKEN: ${{ secrets.BLACKDUCK_ACCESS_TOKEN }}
  BLACKDUCK_URL: ${{ secrets.BLACKDUCK_URL }}
  SPM_BUILD: ${{ vars.SPM_BUILD }}

permissions:
  contents: write
  packages: write
  actions: read


jobs:
  android-pipeline:
    name: Android Pipeline (Build, Test, Publish)
    runs-on: macos-latest-xlarge
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Android Pipeline (Build, Lint, Test, [Publish])
        run: make pipeline-android
        env:
          PUBLISH: ${{ env.DRY_RUN != 'true' }}
          VERSION_OVERRIDE: ${{ env.VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPO: ${{ github.repository }}

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          retention-days: 1
          if-no-files-found: error
          path: |
            engagement-cloud-sdk/build/outputs/aar/*-release.aar
            engagement-cloud-sdk-android-fcm/build/outputs/aar/*-release.aar
            engagement-cloud-sdk-android-hms/build/outputs/aar/*-release.aar


  js-pipeline:
    name: JS Pipeline (Build, Test, Publish)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@emartech'

      - name: Install npm dependencies
        run: npm install

      - name: Install Chrome for tests
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update -q
          sudo apt-get install -y google-chrome-stable

      - name: Run JS Pipeline (Build, Test)
        run: make pipeline-js

      - name: Assemble NPM package
        run: |
          mkdir -p dist/npm
          cp engagement-cloud-sdk/build/kotlin-webpack/js/productionExecutable/engagement-cloud-sdk-html.js dist/npm/
          cp build/js/packages/engagement-cloud-sdk/kotlin/engagement-cloud-sdk-html.d.ts dist/npm/ 2>/dev/null || true
          sed "s/\"version\": \"0.0.0\"/\"version\": \"${{ env.VERSION }}\"/" \
            engagement-cloud-sdk/npm-package.json > dist/npm/package.json

      - name: Publish to GitHub Packages NPM
        if: env.DRY_RUN != 'true'
        run: npm publish dist/npm/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload JS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: js-artifacts
          retention-days: 1
          if-no-files-found: error
          path: dist/npm/


  ios-pipeline:
    name: iOS Pipeline (Build, Test, Publish)
    runs-on: macos-latest-xlarge
    env:
      SPM_BUILD: release
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Cache Konan directory
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('**/*.gradle.kts', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - uses: gradle/actions/setup-gradle@v4

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Create GitHub Release for SPM artifact
        if: env.DRY_RUN != 'true'
        id: spm_release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: spm-${{ env.VERSION }}
          name: SPM Release ${{ env.VERSION }}
          prerelease: true
          generate_release_notes: false

      - name: Run iOS Pipeline (Build, Test, [Publish Maven], [Publish SPM])
        run: make pipeline-ios
        env:
          PUBLISH: ${{ env.DRY_RUN != 'true' }}
          VERSION_OVERRIDE: ${{ env.VERSION }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_ARTIFACT_RELEASE_ID: ${{ steps.spm_release.outputs.id }}

      - name: Upload iOS XCFramework artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          retention-days: 1
          if-no-files-found: error
          path: |
            engagement-cloud-sdk/build/XCFrameworks/release/*.xcframework
            ios-notification-service/build/XCFrameworks/release/*.xcframework


  report-slack:
    name: Report / Slack
    if: always()
    needs: [android-pipeline, js-pipeline, ios-pipeline]
    runs-on: ubuntu-latest
    steps:
      - name: Compute Slack prefix
        id: prefix
        run: |
          if [ "${{ env.DRY_RUN }}" = "true" ]; then
            echo "value=[DRY RUN] " >> "$GITHUB_OUTPUT"
          else
            echo "value=" >> "$GITHUB_OUTPUT"
          fi

      - name: Notify Slack (failure)
        if: ${{ !cancelled() && contains(needs.*.result, 'failure') }}
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: mobile-team-ci
          text: '${{ steps.prefix.outputs.value }}Publish pipeline failed! :man-gesturing-no: :blobcatfearful:'
          fields: repo,workflow,job,took
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}

      - name: Notify Slack (success)
        if: ${{ !cancelled() && !contains(needs.*.result, 'failure') }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: mobile-team-ci
          text: '${{ steps.prefix.outputs.value }}Publish pipeline succeeded! v${{ env.VERSION }} :man-gesturing-ok: :bananadance:'
          fields: repo,workflow,job,took
          github_token: ${{ secrets.GITHUB_TOKEN }}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK }}
